<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <link rel="apple-touch-icon" href="/images/thermostat-icon.png">
    <meta name="viewport" content="width=395">
    <meta name="apple-mobile-web-app-capable" content="yes">
  </head>
  <body>

    <script src="/javascripts/jquery-3.2.1.js"></script>
    <script>
            
      function reload_data() {
        $.getJSON("/api/heatpumps")
        .done(function( heatpumps) {
          $.each(heatpumps, function(index, heatpump) {
            console.log( heatpump )
            heatpump_id = heatpump.id
            $("#" + heatpump_id).attr("data-power", heatpump.power)
            $("#" + heatpump_id).attr("data-mode", heatpump.mode)
            $("#" + heatpump_id + " .hp_room_temp").attr("data-room-temp", heatpump.room_temp)
            $("#" + heatpump_id + " .hp_target_temp").attr("data-target-temp", heatpump.target_temp)
          });
        })
        .fail(function() {
          console.log( "Error calling /api/heatpumps..." );
        })
      }
            
      function reload_heatpump(heatpump_id) {
        $("#" + heatpump_id).load("/heatpumps/" + heatpump_id);
      }
      
      function show_mode_selector(heatpump_id) {
        html_to_add = ''
        $("#" + heatpump_id + ".mode_select").html(html_to_add)
      }
      
      function heatpumps_finished_loading () {
        // When the heatpump view has loaded, set a timer to reload in 10 seconds
        setTimeout(function() {
           $("#heatpumps").load("/heatpumps", heatpumps_finished_loading);
        }, 10000);
        
        $(".hp_power").click(function() {
          heatpump_id = $(this).attr("id")
          current_power = $(this).attr("data-power")
          new_power = (current_power == "ON") ? "OFF" : "ON"
          console.log("current_power: " + current_power)
          console.log("new_power: " + new_power)
          
          // First PUT the new state via the API, then reload
          $.ajax({
              url: "/api/heatpumps/" + heatpump_id,
              method: 'PUT',
              data: {"power": new_power},
              success: function(result) {
                  // Do something with the result
                  console.log("Successful PUT")
                  reload_heatpump(heatpump_id)
              }
          });
        });
        
        $(".hp_mode").click(function() {
          heatpump_id = $(this).attr("id")
          console.log(heatpump_id)
          $(this).hide();
          show_mode_selector(heatpump_id);
        });
      }      
    </script>

    <!-- Start with an empty div, load with an AJAX call -->
    <div id="heatpumps">
      <%- include heatpumps %>
    </div>
    
    <script>  
      
      function refresh_loop() {
        reload_data()
        
        setTimeout(function() {
           refresh_loop();
        }, 10000);
      }
      
      $(document).ready(function() {
        
        setTimeout(function() {
           refresh_loop();
        }, 10000);
      }); 
      
    </script>
    
  </body>
</html>